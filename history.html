<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch History - ENHA-FLIX</title>
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>
    <div id="history-page" class="page active">
        <header class="main-header">
            <a href="engene.html" class="header-logo">ENHA-FLIX</a>
            <div class="header-actions">
                <button class="clear-history-btn" onclick="clearAllHistory()">Clear All History</button>
            </div>
        </header>

        <div class="history-container">
            <div class="history-header">
                <h1 class="history-title">Watch History</h1>
                <p class="history-subtitle">Your ENHYPEN viewing journey</p>
            </div>

            <div class="history-controls">
                <div class="history-stats" id="history-stats">
                    <!-- Stats will be loaded here -->
                </div>
                <div class="history-filters">
                    <button class="filter-btn active" onclick="filterHistory('all')">All</button>
                    <button class="filter-btn" onclick="filterHistory('unfinished')">Continue Watching</button>
                    <button class="filter-btn" onclick="filterHistory('finished')">Finished</button>
                </div>
            </div>

            <div class="history-list" id="history-list">
                <!-- History items will be loaded here -->
            </div>

            <div class="empty-history" id="empty-history">
                <div class="empty-icon">üé¨</div>
                <h2>No Watch History Yet</h2>
                <p>Start watching ENHYPEN content and it will appear here!</p>
                <a href="engene.html" class="browse-btn">Start Browsing</a>
            </div>
        </div>
    </div>

    <script>
        // ===== HISTORY PAGE FUNCTIONALITY =====
        let currentFilter = 'all';

        function loadHistoryPage() {
            updateHistoryStats();
            displayHistory();
        }

        function updateHistoryStats() {
            const statsElement = document.getElementById('history-stats');
            const history = getHistory();
            
            const total = history.length;
            const finished = history.filter(item => item.finished).length;
            const unfinished = total - finished;
            
            statsElement.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Watched</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${finished}</div>
                    <div class="stat-label">Finished</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${unfinished}</div>
                    <div class="stat-label">In Progress</div>
                </div>
            `;
        }

        function displayHistory() {
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');
            const history = getHistory();
            
            let filteredHistory = history;
            
            // Apply filters
            if (currentFilter === 'unfinished') {
                filteredHistory = history.filter(item => !item.finished);
            } else if (currentFilter === 'finished') {
                filteredHistory = history.filter(item => item.finished);
            }
            
            if (filteredHistory.length === 0) {
                historyList.style.display = 'none';
                emptyHistory.style.display = 'block';
                return;
            }
            
            historyList.style.display = 'block';
            emptyHistory.style.display = 'none';
            
            historyList.innerHTML = filteredHistory.map(item => createHistoryListItem(item)).join('');
        }

        function createHistoryListItem(item) {
            const progressPercent = Math.round(item.progress);
            const timeAgo = getTimeAgo(item.lastWatched);
            const watchDate = new Date(item.lastWatched).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            return `
                <div class="history-list-item" data-id="${item.id}">
                    <div class="history-list-thumbnail" onclick="playFromHistory('${item.id}')">
                        <img src="${item.thumbnail || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE3MCIgdmlld0JveD0iMCAwIDMwMCAxNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTcwIiBmaWxsPSIjMzMzIi8+CjxwYXRoIGQ9Ik0xMjAgODVMMTQwIDcwTDE2MCA4NUwxNDAgMTAwTDEyMCA4NVoiIGZpbGw9IiNlNTA5MTQiLz4KPC9zdmc+'}">
                        <div class="progress-overlay-list" style="width: ${100 - progressPercent}%"></div>
                        <div class="progress-badge ${item.finished ? 'finished' : 'in-progress'}">
                            ${item.finished ? '‚úì' : `${progressPercent}%`}
                        </div>
                    </div>
                    <div class="history-list-info">
                        <div class="history-list-title">${item.title}</div>
                        <div class="history-list-meta">
                            <span class="progress-text">Progress: ${progressPercent}%</span>
                            <span class="date-text">${watchDate}</span>
                            <span class="time-text">${timeAgo}</span>
                        </div>
                        <div class="history-list-actions">
                            <button class="history-action continue-watching" onclick="playFromHistory('${item.id}')">
                                ${item.finished ? 'üîÑ Rewatch' : '‚ñ∂ Continue'}
                            </button>
                            <button class="history-action remove-item" onclick="removeHistoryItem('${item.id}')">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterHistory(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayHistory();
        }

        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all watch history? This cannot be undone.')) {
                localStorage.removeItem('enhaflix_watch_history');
                loadHistoryPage();
                
                // Also update the main page if it's open
                if (window.opener) {
                    window.opener.WatchHistory.updateContinueWatching();
                }
            }
        }

        function removeHistoryItem(videoId) {
            const history = getHistory();
            const filtered = history.filter(item => item.id !== videoId);
            localStorage.setItem('enhaflix_watch_history', JSON.stringify(filtered));
            loadHistoryPage();
            
            // Also update the main page if it's open
            if (window.opener) {
                window.opener.WatchHistory.updateContinueWatching();
            }
        }

        function playFromHistory(videoId) {
            const history = getHistory();
            const item = history.find(h => h.id === videoId);
            
            if (item) {
                // Open in video modal (you'll need to implement this)
                window.open(`engene.html?play=${encodeURIComponent(item.url)}`, '_blank');
            }
        }

        // ===== HELPER FUNCTIONS =====
        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('enhaflix_watch_history')) || [];
            } catch {
                return [];
            }
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // ===== INITIALIZE HISTORY PAGE =====
        document.addEventListener('DOMContentLoaded', function() {
            loadHistoryPage();
        });
    </script>
</body>
</html>